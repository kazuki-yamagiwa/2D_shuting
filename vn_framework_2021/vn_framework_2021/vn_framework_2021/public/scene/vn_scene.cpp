//--------------------------------------------------------------//
//	"vn_scene.cpp"												//
//		シーン基底クラス										//
//													2021/06/01	//
//														Ichii	//
//--------------------------------------------------------------//
#include "../../framework.h"
#include "../../framework/vn_environment.h"

//静的メンバ変数の初期化
bool vnScene::UpdateRenderPriority = false;

//コンストラクタ
vnScene::vnScene()
{
	for (int i = 0; i < vnOBJECT2D_MAX; i++)
	{
		pObject2D_Array[i] = NULL;
	}
	UpdateRenderPriority = false;
}

//デストラクタ
vnScene::~vnScene()
{
	for (int i = 0; i < vnOBJECT2D_MAX; i++)
	{
		if (pObject2D_Array[i] == NULL)continue;
		delete pObject2D_Array[i];
		pObject2D_Array[i] = NULL;
	}
	UpdateRenderPriority = false;
}

//処理
void vnScene::execute()
{
	//2Dオブジェクトのexecute関数の実行
	for (int i = 0; i < vnOBJECT2D_MAX; i++)
	{
		if (pObject2D_Array[i] == NULL)continue;
		if (pObject2D_Array[i]->isExecuteEnable() == false)continue;
		pObject2D_Array[i]->execute();
	}
}

//描画
void vnScene::render()
{
	if (UpdateRenderPriority == true)	//ソートの必要がある時のみソートする
	{
		//描画優先順位に従って配列をソート
		for (int i = 0; i < vnOBJECT2D_MAX - 1; i++)
		{
			if (pObject2D_Array[i] == NULL)continue;
			for (int j = i + 1; j < vnOBJECT2D_MAX; j++)
			{
				if (pObject2D_Array[j] == NULL)continue;
				if (pObject2D_Array[i]->getRenderPriority() > pObject2D_Array[j]->getRenderPriority())
				{
					vnSprite* tmp = pObject2D_Array[i];
					pObject2D_Array[i] = pObject2D_Array[j];
					pObject2D_Array[j] = tmp;
				}
			}
		}
		UpdateRenderPriority = false;	//ソートが完了したら、次にソートが必要になるまでソートしないようにする
	}

	//2Dオブジェクトのrender関数の実行
	for (int i = 0; i < vnOBJECT2D_MAX; i++)
	{
		if (pObject2D_Array[i] == NULL)continue;
		if (pObject2D_Array[i]->isRenderEnable() == false)continue;
		pObject2D_Array[i]->render();
	}
}

//描画優先順位が変更されたので、ソートをする必要がある
void vnScene::setUpdateRenderPriority()
{
	UpdateRenderPriority = true;
}


//2Dオブジェクトの登録(配列の空きに入れる)
bool vnScene::registerObject(vnSprite* p)
{
	if (p == NULL)
	{
		return false;
	}
	for (int i = 0; i < vnOBJECT2D_MAX; i++)
	{
		if (pObject2D_Array[i] != NULL)continue;
		pObject2D_Array[i] = p;
		return true;
	}
	return false;
}

//2Dオブジェクトの破棄(配列から削除)
void vnScene::deleteObject(vnSprite* p)
{
	if (p == NULL)
	{
		return;
	}
	for (int i = 0; i < vnOBJECT2D_MAX; i++)
	{
		if (pObject2D_Array[i] == NULL)continue;
		if (pObject2D_Array[i] == p)
		{
			delete pObject2D_Array[i];
			pObject2D_Array[i] = NULL;
		}
	}
}
